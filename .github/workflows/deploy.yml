name: Deploy

on:
  # Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð¿Ñ€Ð¸ push Ð² master (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ release merges)
  push:
    branches: [master]
  # Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ
  workflow_dispatch:
    inputs:
      version:
        description: 'Ð’ÐµÑ€ÑÐ¸Ñ Ð´Ð»Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾, Ð±ÑƒÐ´ÐµÑ‚ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð° Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸)'
        required: false
        type: string

jobs:
  # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð½ÑƒÐ¶Ð½Ð¾ Ð»Ð¸ Ð´ÐµÐ»Ð°Ñ‚ÑŒ Ð´ÐµÐ¿Ð»Ð¾Ð¹
  check-deploy:
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
      version: ${{ steps.check.outputs.version }}
      is_prerelease: ${{ steps.check.outputs.is_prerelease }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # ÐÑƒÐ¶Ð½Ð¾ Ð´Ð»Ñ ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ñ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¾Ð²
          
      - name: Check if deploy needed
        id: check
        run: |
          # Ð•ÑÐ»Ð¸ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð¾ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ -n "${{ github.event.inputs.version }}" ]; then
              VERSION="${{ github.event.inputs.version }}"
            else
              VERSION=$(node -p "require('./package.json').version")
            fi
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "is_prerelease=$(echo $VERSION | grep -q '-' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
            echo "ðŸš€ Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº Ð´ÐµÐ¿Ð»Ð¾Ñ Ð²ÐµÑ€ÑÐ¸Ð¸ $VERSION"
            exit 0
          fi
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ commit message Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð´ÐµÐ¿Ð»Ð¾Ñ
          COMMIT_MSG=$(git log -1 --pretty=%s)
          echo "Commit message: $COMMIT_MSG"
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÑÐ²Ð»ÑÐµÑ‚ÑÑ Ð»Ð¸ ÑÑ‚Ð¾ Ð¼ÐµÑ€Ð¶ÐµÐ¼ release Ð²ÐµÑ‚ÐºÐ¸
          if echo "$COMMIT_MSG" | grep -qE "(Merge pull request .* from .*/release/v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+(\\.[0-9]+)?)?|Merge branch 'release/v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+(\\.[0-9]+)?)?'|Release v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+(\\.[0-9]+)?)? \\(#[0-9]+\\))"; then
            echo "âœ… ÐÐ°Ð¹Ð´ÐµÐ½ Ð¼ÐµÑ€Ð¶ release Ð²ÐµÑ‚ÐºÐ¸ - Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ð½ÑƒÐ¶ÐµÐ½"
            
            # Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð¸Ð· commit message
            VERSION=$(echo "$COMMIT_MSG" | grep -oE "v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+(\\.[0-9]+)?)?" | head -1 | sed 's/^v//')
            
            if [ -z "$VERSION" ]; then
              # Ð•ÑÐ»Ð¸ Ð½Ðµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¸Ð·Ð²Ð»ÐµÑ‡ÑŒ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð¸Ð· ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð°, Ð±ÐµÑ€ÐµÐ¼ Ð¸Ð· package.json
              VERSION=$(node -p "require('./package.json').version")
              echo "âš ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¸Ð·Ð²Ð»ÐµÑ‡ÑŒ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð¸Ð· ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð°, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð¸Ð· package.json: $VERSION"
            else
              echo "ðŸŽ¯ Ð˜Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð° Ð²ÐµÑ€ÑÐ¸Ñ Ð¸Ð· ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð°: $VERSION"
            fi
            
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "is_prerelease=$(echo $VERSION | grep -q '-' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          else
            echo "âŒ Ð­Ñ‚Ð¾ Ð½Ðµ Ð¼ÐµÑ€Ð¶ release Ð²ÐµÑ‚ÐºÐ¸ - Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ðµ Ð½ÑƒÐ¶ÐµÐ½"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

  # ÐžÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ð´ÐµÐ¿Ð»Ð¾Ð¹
  deploy:
    needs: check-deploy
    if: needs.check-deploy.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write # Ð”Ð»Ñ npm provenance
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run tests
        run: npm test
        
      - name: Build packages
        run: npm run build
        
      - name: Security audit
        run: npm run audit:ci
        continue-on-error: true # ÐÐµ Ð±Ð»Ð¾ÐºÐ¸Ñ€ÑƒÐµÐ¼ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ð¸Ð·-Ð·Ð° Ð°ÑƒÐ´Ð¸Ñ‚Ð°
        
      - name: Verify version consistency
        run: |
          EXPECTED_VERSION="${{ needs.check-deploy.outputs.version }}"
          echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð²ÐµÑ€ÑÐ¸Ð¸ Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²..."
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð²ÑÐµ package.json Ñ„Ð°Ð¹Ð»Ñ‹
          find packages -name "package.json" -exec sh -c '
            PACKAGE_VERSION=$(node -p "require(\"$1\").version")
            PACKAGE_NAME=$(node -p "require(\"$1\").name")
            echo "ðŸ“¦ $PACKAGE_NAME: $PACKAGE_VERSION"
            if [ "$PACKAGE_VERSION" != "'"$EXPECTED_VERSION"'" ]; then
              echo "âŒ Ð’ÐµÑ€ÑÐ¸Ñ Ð¿Ð°ÐºÐµÑ‚Ð° $PACKAGE_NAME ($PACKAGE_VERSION) Ð½Ðµ ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ Ð¾Ð¶Ð¸Ð´Ð°ÐµÐ¼Ð¾Ð¹ ('"$EXPECTED_VERSION"')"
              exit 1
            fi
          ' _ {} \;
          
          echo "âœ… Ð’ÑÐµ Ð²ÐµÑ€ÑÐ¸Ð¸ Ð¿Ð°ÐºÐµÑ‚Ð¾Ð² ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‚ Ð¾Ð¶Ð¸Ð´Ð°ÐµÐ¼Ð¾Ð¹: $EXPECTED_VERSION"
          
      - name: Publish to npm
        run: |
          echo "ðŸ“¦ ÐŸÑƒÐ±Ð»Ð¸ÐºÑƒÐµÐ¼ Ð¿Ð°ÐºÐµÑ‚Ñ‹ Ð² npm..."
          
          # ÐŸÑƒÐ±Ð»Ð¸ÐºÑƒÐµÐ¼ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð¿Ð°ÐºÐµÑ‚
          for package_dir in packages/*/; do
            if [ -f "$package_dir/package.json" ]; then
              PACKAGE_NAME=$(node -p "require('./$package_dir/package.json').name")
              PACKAGE_VERSION=$(node -p "require('./$package_dir/package.json').version")
              
              echo "ðŸš€ ÐŸÑƒÐ±Ð»Ð¸ÐºÑƒÐµÐ¼ $PACKAGE_NAME@$PACKAGE_VERSION..."
              
              cd "$package_dir"
              
              # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð½Ðµ Ð¾Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ¾Ð²Ð°Ð½Ð° Ð»Ð¸ ÑƒÐ¶Ðµ ÑÑ‚Ð° Ð²ÐµÑ€ÑÐ¸Ñ
              if npm view "$PACKAGE_NAME@$PACKAGE_VERSION" version 2>/dev/null; then
                echo "âš ï¸ Ð’ÐµÑ€ÑÐ¸Ñ $PACKAGE_NAME@$PACKAGE_VERSION ÑƒÐ¶Ðµ Ð¾Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ¾Ð²Ð°Ð½Ð°, Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼"
              else
                # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ñ‚ÐµÐ³ Ð´Ð»Ñ Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ð¸
                if [[ "$PACKAGE_VERSION" == *"-"* ]]; then
                  NPM_TAG="beta"
                else
                  NPM_TAG="latest"
                fi
                
                echo "ðŸ“¤ ÐŸÑƒÐ±Ð»Ð¸ÐºÑƒÐµÐ¼ Ñ Ñ‚ÐµÐ³Ð¾Ð¼: $NPM_TAG"
                npm publish --tag "$NPM_TAG" --provenance --access public
                echo "âœ… $PACKAGE_NAME@$PACKAGE_VERSION Ð¾Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ¾Ð²Ð°Ð½"
              fi
              
              cd - > /dev/null
            fi
          done
          
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          
      - name: Create/Update GitHub Release
        run: |
          VERSION="${{ needs.check-deploy.outputs.version }}"
          TAG_NAME="v$VERSION"
          IS_PRERELEASE="${{ needs.check-deploy.outputs.is_prerelease }}"
          
          echo "ðŸŽ‰ ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ GitHub Release: $TAG_NAME"
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ð»Ð¸ ÑƒÐ¶Ðµ release (draft)
          if gh release view "$TAG_NAME" >/dev/null 2>&1; then
            echo "ðŸ“ ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ draft release..."
            
            # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ðµ release notes
            CURRENT_NOTES=$(gh release view "$TAG_NAME" --json body -q .body)
            
            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» Ð´Ð»Ñ Ð½Ð¾Ð²Ñ‹Ñ… notes
            cat > /tmp/release_notes.md << 'EOF'
          $CURRENT_NOTES
          
          ## ðŸš€ Ð ÐµÐ»Ð¸Ð· Ð¾Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ¾Ð²Ð°Ð½!
          
          âœ… **Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:** ÐžÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ¾Ð²Ð°Ð½  
          ðŸ“¦ **npm Ð¿Ð°ÐºÐµÑ‚Ñ‹:** ÐžÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ¾Ð²Ð°Ð½Ñ‹  
          ðŸ·ï¸ **Ð¢ÐµÐ³:** `$TAG_NAME`  
          ðŸ“… **Ð”Ð°Ñ‚Ð°:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')  
          
          ### ðŸ“¦ ÐžÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð°ÐºÐµÑ‚Ñ‹:
          EOF
            
            # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¾Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ¾Ð²Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²
            for package_dir in packages/*/; do
              if [ -f "$package_dir/package.json" ]; then
                PACKAGE_NAME=$(node -p "require('./$package_dir/package.json').name")
                echo "- [\`$PACKAGE_NAME@$VERSION\`](https://www.npmjs.com/package/$PACKAGE_NAME/v/$VERSION)" >> /tmp/release_notes.md
              fi
            done
            
            # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ release (ÑƒÐ±Ð¸Ñ€Ð°ÐµÐ¼ draft ÑÑ‚Ð°Ñ‚ÑƒÑ)
            gh release edit "$TAG_NAME" \
              --notes-file /tmp/release_notes.md \
              --draft=false \
              --prerelease="$IS_PRERELEASE"
              
            echo "âœ… Draft release Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½ Ð¸ Ð¾Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ¾Ð²Ð°Ð½!"
            
          else
            echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ release..."
            
            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» Ð´Ð»Ñ release notes
            cat > /tmp/release_notes.md << EOF
          ## ðŸš€ Release v$VERSION
          
          ### ðŸ“¦ ÐžÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð°ÐºÐµÑ‚Ñ‹:
          EOF
            
            for package_dir in packages/*/; do
              if [ -f "$package_dir/package.json" ]; then
                PACKAGE_NAME=$(node -p "require('./$package_dir/package.json').name")
                echo "- [\`$PACKAGE_NAME@$VERSION\`](https://www.npmjs.com/package/$PACKAGE_NAME/v/$VERSION)" >> /tmp/release_notes.md
              fi
            done
            
            cat >> /tmp/release_notes.md << EOF
          
          ---
          
          âœ… **Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:** ÐžÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ¾Ð²Ð°Ð½  
          ðŸ“… **Ð”Ð°Ñ‚Ð°:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')  
          EOF
            
            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ release
            gh release create "$TAG_NAME" \
              --title "ðŸš€ Release v$VERSION" \
              --notes-file /tmp/release_notes.md \
              --prerelease="$IS_PRERELEASE"
              
            echo "âœ… ÐÐ¾Ð²Ñ‹Ð¹ release ÑÐ¾Ð·Ð´Ð°Ð½!"
          fi
          
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Summary
        run: |
          VERSION="${{ needs.check-deploy.outputs.version }}"
          echo "## ðŸŽ‰ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Ð§Ñ‚Ð¾ Ð¾Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ¾Ð²Ð°Ð½Ð¾:" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ·ï¸ Ð’ÐµÑ€ÑÐ¸Ñ:** \`v$VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ“¦ npm Ð¿Ð°ÐºÐµÑ‚Ñ‹:** ÐžÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ¾Ð²Ð°Ð½Ñ‹" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸŽ‰ GitHub Release:** [v$VERSION](https://github.com/${{ github.repository }}/releases/tag/v$VERSION)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ ÐžÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð°ÐºÐµÑ‚Ñ‹:" >> $GITHUB_STEP_SUMMARY
          
          for package_dir in packages/*/; do
            if [ -f "$package_dir/package.json" ]; then
              PACKAGE_NAME=$(node -p "require('./$package_dir/package.json').name")
              echo "- [\`$PACKAGE_NAME@$VERSION\`](https://www.npmjs.com/package/$PACKAGE_NAME/v/$VERSION)" >> $GITHUB_STEP_SUMMARY
            fi
          done 